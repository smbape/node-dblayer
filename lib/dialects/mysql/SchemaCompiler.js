// Generated by CoffeeScript 1.12.4
var ColumnCompiler, MysqlSchemaCompiler, SchemaCompiler, _, tools,
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

_ = require('lodash');

tools = require('../../tools');

SchemaCompiler = require('../../schema/SchemaCompiler');

ColumnCompiler = require('./ColumnCompiler');

module.exports = MysqlSchemaCompiler = (function(superClass) {
  extend(MysqlSchemaCompiler, superClass);

  function MysqlSchemaCompiler() {
    return MysqlSchemaCompiler.__super__.constructor.apply(this, arguments);
  }

  MysqlSchemaCompiler.prototype.ColumnCompiler = ColumnCompiler;

  MysqlSchemaCompiler.prototype.validUpdateActions = ['no_action', 'restrict', 'cascade', 'set_null'];

  MysqlSchemaCompiler.prototype.dropColumn = function(tableName, column, options) {
    var LF, escapeId, indent, ref, words;
    ref = this, words = ref.words, escapeId = ref.escapeId, indent = ref.indent, LF = ref.LF;
    return words.alter_table + ' ' + escapeId(tableName) + LF + indent + words.drop_column + ' ' + escapeId(column);
  };

  MysqlSchemaCompiler.prototype.diffType = function(tableName, column, oldColumnSpec, newColumnSpec) {
    var LF, altersql, args, columnCompiler, columnId, escapeId, indent, newModifier, newTypeString, oldModifier, oldTypeString, options, ref, tablesql, words;
    options = _.defaults({}, options, this.options);
    ref = this, words = ref.words, escapeId = ref.escapeId, columnCompiler = ref.columnCompiler, args = ref.args, indent = ref.indent, LF = ref.LF;
    args.table = tableName;
    args.column = column;
    columnId = escapeId(column);
    tablesql = [words.alter_table, ' '];
    if (options.if_exists) {
      tablesql.push(words.if_exists);
      tablesql.push(' ');
    }
    tablesql.push.apply(tablesql, [escapeId(tableName), LF]);
    altersql = [];
    oldTypeString = columnCompiler.getTypeString(oldColumnSpec);
    newTypeString = columnCompiler.getTypeString(newColumnSpec);
    oldModifier = columnCompiler.getColumnModifier(oldColumnSpec);
    newModifier = columnCompiler.getColumnModifier(newColumnSpec);
    if (oldTypeString !== newTypeString) {
      if (oldColumnSpec.type === 'enum' && newColumnSpec.type === 'enum') {
        return;
      }
      tablesql.push.apply(tablesql, [indent, words.change_column, ' ', columnId, ' ', columnId, ' ', newTypeString, ' ', newModifier]);
    } else if (oldModifier !== newModifier) {
      return;
    } else {
      return;
    }
    return tablesql.join('');
  };

  MysqlSchemaCompiler.prototype.renamePrimaryKey = function() {};

  MysqlSchemaCompiler.prototype.dropPrimaryKey = function(tableName, oldName, options) {
    var LF, escapeId, indent, ref, words;
    options = _.defaults({}, options, this.options);
    ref = this, words = ref.words, escapeId = ref.escapeId, indent = ref.indent, LF = ref.LF;
    return words.alter_table + ' ' + escapeId(tableName) + LF + indent + words.drop_primary_key;
  };

  MysqlSchemaCompiler.prototype.renameForeignKey = function(newTableModel, oldName, newKey, oldTableModel, options) {
    return this.dropForeignKey(oldTableModel, oldName, options) + ';\n' + this.addForeignKey(newTableModel, newKey, options);
  };

  MysqlSchemaCompiler.prototype.dropForeignKey = function(oldTableModel, oldName, options) {
    var LF, escapeId, indent, ref, ref1, ref2, sql, words;
    options = _.defaults({}, options, this.options);
    ref = this, words = ref.words, escapeId = ref.escapeId, indent = ref.indent, LF = ref.LF;
    sql = words.alter_table + ' ' + escapeId(oldTableModel.name) + LF + indent + words.drop_foreign_key + ' ' + escapeId(oldName);
    if ((ref1 = oldTableModel.indexes) != null ? ref1.hasOwnProperty(oldName) : void 0) {
      delete oldTableModel.indexes[oldName];
    }
    if ((ref2 = oldTableModel.constraints.UNIQUE) != null ? ref2.hasOwnProperty(oldName) : void 0) {
      delete oldTableModel.constraints.UNIQUE[oldName];
    }
    return sql;
  };

  MysqlSchemaCompiler.prototype.renameIndex = function(tableName, oldName, newName, options) {
    var LF, escapeId, indent, ref, words;
    ref = this, words = ref.words, escapeId = ref.escapeId, indent = ref.indent, LF = ref.LF;
    return words.alter_table + ' ' + escapeId(tableName) + LF + indent + words.rename_index + ' ' + escapeId(oldName) + ' ' + words.to + ' ' + escapeId(newName);
  };

  MysqlSchemaCompiler.prototype.dropIndex = function(tableName, indexName, options) {
    var LF, escapeId, indent, ref, words;
    if (options == null) {
      options = {};
    }
    options = _.defaults({}, options, this.options);
    ref = this, words = ref.words, escapeId = ref.escapeId, indent = ref.indent, LF = ref.LF;
    return words.alter_table + ' ' + escapeId(tableName) + LF + indent + words.drop_index + ' ' + escapeId(indexName);
  };

  return MysqlSchemaCompiler;

})(SchemaCompiler);

MysqlSchemaCompiler.prototype.renameUniqueIndex = MysqlSchemaCompiler.prototype.renameIndex;

MysqlSchemaCompiler.prototype.dropUniqueIndex = MysqlSchemaCompiler.prototype.dropIndex;
